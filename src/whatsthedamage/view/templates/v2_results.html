<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>"What's the Damage" - {{ _('Result') }}</title>
    <link href="{{ url_for('static', filename='dist/css/main.css') }}" rel="stylesheet">
    <script type="module" src="{{ url_for('static', filename='dist/js/main.js') }}"></script>
    <!-- Translated strings for JavaScript -->
    <script>
        globalThis.resultId = '{{ result_id }}';
        globalThis.exportCsvText = '{{ _("Export CSV") }}';
        globalThis.exportExcelText = '{{ _("Export Excel") }}';
    </script>
</head>
<body>
    <header>
        {% include 'header.html' %}
    </header>
    <main class="container-fluid">
        <h1 class="text-center p-2 pb-1">{{ _('Processed results') }}</h1>

        <div class="row row-cols-auto">
            <div class="col">
                <button class="btn btn-outline-info" type="button" data-bs-toggle="collapse" data-bs-target="#legend" aria-expanded="false" aria-controls="legend">
                    {{ _('Legend') }}
                </button>
                <div class="collapse" id="legend">
                    <div class="card card-body">
                        <p><span class="badge highlight-outlier">Outlier</span> {{ _('Cells highlighted in red indicate outliers detected by IQR method.') }}</p>
                        <p><span class="badge highlight-pareto">Pareto</span> {{ _('Cells highlighted in green indicate top contributors per Pareto principle.') }}</p>
                        <p><span class="badge highlight-excluded">Excluded</span> {{ _('Cells highlighted in light grey are excluded from statistical analysis (calculated rows or excluded categories).') }}</p>
                    </div>
                </div>
            </div>
            <div class="col">
                <button class="btn btn-outline-primary" type="button" data-bs-toggle="collapse" data-bs-target="#stats-controls" aria-expanded="false" aria-controls="stats-controls">
                    {{ _('Statistical Analysis Controls') }}
                </button>
                <div class="collapse" id="stats-controls">
                    <div class="card card-body">
                        <div class="mb-3">
                            <h6>{{ _('Algorithms') }}</h6>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" value="iqr" id="algorithm-iqr" checked>
                                <label class="form-check-label" for="algorithm-iqr">
                                    {{ _('IQR Outlier Detection') }}
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" value="pareto" id="algorithm-pareto" checked>
                                <label class="form-check-label" for="algorithm-pareto">
                                    {{ _('Pareto Analysis') }}
                                </label>
                            </div>
                        </div>

                        <div class="mb-3">
                            <h6>{{ _('Analysis Direction') }}</h6>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="direction" id="direction-rows" value="rows">
                                <label class="form-check-label" for="direction-rows">
                                    {{ _('Rows') }}
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="direction" id="direction-columns" value="columns" checked>
                                <label class="form-check-label" for="direction-columns">
                                    {{ _('Columns') }}
                                </label>
                            </div>
                        </div>

                        <div class="d-flex gap-2">
                            <button id="recalculate-btn" class="btn btn-primary btn-sm">
                                <output class="spinner-border spinner-border-sm d-none" aria-hidden="true"></output>
                                <span>{{ _('Recalculate') }}</span>
                            </button>
                            <button id="reset-btn" class="btn btn-secondary btn-sm">{{ _('Reset to Defaults') }}</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        {% for account in accounts_data.accounts %}
        {% set dt_response = account.dt_response %}
        <div class="account-section">
            <div class="account-header">
                <h2>
                    {{ account.formatted_id }}
                    {% if account.currency %}
                        ({{ account.currency }})
                    {% endif %}
                </h2>
            </div>
            
            <div class="row">
                <div class="col-md-12 mb-3">
                    <div class="table-responsive">
                        <table id="datatable-{{ account.id | replace(':', '-') | replace(' ', '-') }}" class="table table-bordered" data-datatable="true">
                            <thead>
                                <tr>
                                    <th>{{ _('Categories') }}</th>
                                    {% set months = [] %}
                                    {% for agg_row in dt_response.data %}
                                        {% set _month_field = agg_row.date if agg_row.date is not none else agg_row.month %}
                                        {% if (_month_field.display, _month_field.timestamp) not in months %}
                                            {% set _ = months.append((_month_field.display, _month_field.timestamp)) %}
                                        {% endif %}
                                    {% endfor %}
                                    {% for month_display, month_ts in months | sort(attribute='1', reverse=True) %}
                                        <th data-order="{{ month_ts }}"><a href="/details/{{ result_id }}/{{ account.id }}/month/{{ month_ts }}" class="clickable">{{ month_display }}</a></th>
                                    {% endfor %}
                                </tr>
                            </thead>
                            <tbody>
                                {% set cat_month_map = {} %}
                                    {% for agg_row in dt_response.data %}
                                    {% if agg_row.category not in cat_month_map %}
                                        {% set _ = cat_month_map.update({agg_row.category: {}}) %}
                                    {% endif %}
                                    {% set _month_field = agg_row.date if agg_row.date is not none else agg_row.month %}
                                    {% set _month_key = _month_field.timestamp %}
                                    {% set _ = cat_month_map[agg_row.category].update({_month_key: agg_row}) %}
                                {% endfor %}

                                {% for category in cat_month_map.keys() | sort %}
                                <tr>
                                    <td><a href="/details/{{ result_id }}/{{ account.id }}/{{ category }}" class="clickable">{{ category }}</a></td>
                                    {% for month_display, month_ts in months | sort(attribute='1', reverse=True) %}
                                        {% set agg_row_data = cat_month_map[category].get(month_ts) %}
                                        {% if agg_row_data %}
                                            {% set details_list = [] %}
                                                {% for detail in agg_row_data.details %}
                                                {% set _ = details_list.append(detail.date.display ~ ': ' ~ detail.amount.display ~ ' - ' ~ detail.merchant) %}
                                            {% endfor %}
                                            {% set details_str = details_list | join('<br>') %}
                                            {% set highlight_key = month_display ~ '_' ~ category %}
                                            {% set highlight_type = account.highlights.get(highlight_key, '') %}
                                            {% set highlight_class = 'highlight-' ~ highlight_type if highlight_type else '' %}
                                            <td data-order="{{ agg_row_data.total.raw }}" class="{{ highlight_class }}"
                                                {% if agg_row_data.details %}
                                                    tabindex="0"
                                                    data-bs-toggle="popover"
                                                    data-bs-trigger="hover focus"
                                                    data-bs-html="true"
                                                    data-bs-content="{{ details_str }}"
                                                    data-bs-placement="top"
                                                    data-bs-custom-class="popover-wide"
                                                {% endif %}
                                            ><a href="/details/{{ result_id }}/{{ account.id }}/{{ category }}/{{ month_ts }}" class="clickable">{{ agg_row_data.total.display }}</a></td>
                                        {% else %}
                                            <td data-order="0"></td>
                                        {% endif %}
                                    {% endfor %}
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
        
        <div class="row">
            <div class="col-md-6">
                <a href="/" class="btn btn-secondary mt-3 mb-3">{{ _('Back') }}</a>
            </div>
        </div>
    </main>
    <footer class="bg-success text-white text-center py-3 mt-3">
        {% include 'footer.html' %}
    </footer>
</body>
</html>
