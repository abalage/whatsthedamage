<!DOCTYPE html>
<html lang="en">
<head>
    <style>
    .popover-wide {
        max-width: 400px;
        min-width: 300px;
        word-break: break-word;
    }
    .account-section {
        margin-bottom: 3rem;
    }
    .account-header {
        background-color: #f8f9fa;
        padding: 1rem;
        border-radius: 0.5rem;
        margin-bottom: 1rem;
    }
    .highlight-outlier {
        background-color: #ffe6e6 !important;
    }
    .highlight-pareto {
        background-color: #e6ffe6 !important;
    }
    .highlight-excluded {
        background-color: #f0f0f0 !important;
    }
    .clickable {
        cursor: pointer;
        text-decoration: none;
        color: inherit;
    }
    .clickable:hover {
        text-decoration: underline;
    }
    </style>
    <meta charset="UTF-8">
    <title>"What's the Damage" - {{ _('Result') }}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <!-- DataTables CSS -->
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/2.3.4/css/dataTables.dataTables.min.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/fixedheader/4.0.4/css/fixedHeader.bootstrap5.min.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/buttons/3.2.0/css/buttons.dataTables.min.css">

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous" defer></script>
    <!-- jQuery and DataTables JS -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.datatables.net/2.3.4/js/dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/2.3.4/js/dataTables.bootstrap5.min.js"></script>
    <script src="https://cdn.datatables.net/fixedheader/4.0.4/js/dataTables.fixedHeader.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/3.2.0/js/dataTables.buttons.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/3.2.0/js/buttons.html5.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>

</head>
<body>
    <header>
        {% include 'header.html' %}
    </header>
    <main class="container-fluid">
        <h1 class="text-center p-2 pb-1">{{ _('Processed results') }}</h1>

        <div class="row mb-3">
            <div class="col-md-12">
                <button class="btn btn-outline-info" type="button" data-bs-toggle="collapse" data-bs-target="#legend" aria-expanded="false" aria-controls="legend">
                    {{ _('Legend') }}
                </button>
                <div class="collapse" id="legend">
                    <div class="card card-body">
                        <p><span class="badge bg-danger">Outlier</span> {{ _('Cells highlighted in red indicate outliers detected by IQR method.') }}</p>
                        <p><span class="badge bg-success">Pareto</span> {{ _('Cells highlighted in green indicate top contributors per Pareto principle.') }}</p>
                        <p><span class="badge" style="background-color: #f0f0f0; color: black;">Excluded</span> {{ _('Cells highlighted in light grey are excluded from statistical analysis (calculated rows or excluded categories).') }}</p>
                    </div>
                </div>
            </div>
        </div>

        <div class="row mb-3">
            <div class="col-md-12">
                <button class="btn btn-outline-primary" type="button" data-bs-toggle="collapse" data-bs-target="#stats-controls" aria-expanded="false" aria-controls="stats-controls">
                    {{ _('Statistical Analysis Controls') }}
                </button>
                <div class="collapse" id="stats-controls">
                    <div class="card card-body">
                        <div class="mb-3">
                            <h6>{{ _('Algorithms') }}</h6>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" value="iqr" id="algorithm-iqr" checked>
                                <label class="form-check-label" for="algorithm-iqr">
                                    {{ _('IQR Outlier Detection') }}
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" value="pareto" id="algorithm-pareto" checked>
                                <label class="form-check-label" for="algorithm-pareto">
                                    {{ _('Pareto Analysis') }}
                                </label>
                            </div>
                        </div>

                        <div class="mb-3">
                            <h6>{{ _('Analysis Direction') }}</h6>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="direction" id="direction-rows" value="rows">
                                <label class="form-check-label" for="direction-rows">
                                    {{ _('Rows') }}
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="direction" id="direction-columns" value="columns" checked>
                                <label class="form-check-label" for="direction-columns">
                                    {{ _('Columns') }}
                                </label>
                            </div>
                        </div>

                        <div class="d-flex gap-2">
                            <button id="recalculate-btn" class="btn btn-primary btn-sm">
                                <span class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
                                <span>{{ _('Recalculate') }}</span>
                            </button>
                            <button id="reset-btn" class="btn btn-secondary btn-sm">{{ _('Reset to Defaults') }}</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        {% for account in accounts_data.accounts %}
        {% set dt_response = account.dt_response %}
        <div class="account-section">
            <div class="account-header">
                <h2>
                    {{ account.formatted_id }}
                    {% if account.currency %}
                        ({{ account.currency }})
                    {% endif %}
                </h2>
            </div>
            
            <div class="row">
                <div class="col-md-12 mb-3">
                    <div class="table-responsive">
                        <table id="datatable-{{ account.id | replace(':', '-') | replace(' ', '-') }}" class="table table-bordered" data-datatable="true">
                            <thead>
                                <tr>
                                    <th>{{ _('Categories') }}</th>
                                    {% set months = [] %}
                                    {% for agg_row in dt_response.data %}
                                        {% set _month_field = agg_row.date if agg_row.date is not none else agg_row.month %}
                                        {% if (_month_field.display, _month_field.timestamp) not in months %}
                                            {% set _ = months.append((_month_field.display, _month_field.timestamp)) %}
                                        {% endif %}
                                    {% endfor %}
                                    {% for month_display, month_ts in months | sort(attribute='1', reverse=True) %}
                                        <th data-order="{{ month_ts }}"><a href="/details/{{ result_id }}/{{ account.id }}/month/{{ month_ts }}" class="clickable">{{ month_display }}</a></th>
                                    {% endfor %}
                                </tr>
                            </thead>
                            <tbody>
                                {% set cat_month_map = {} %}
                                    {% for agg_row in dt_response.data %}
                                    {% if agg_row.category not in cat_month_map %}
                                        {% set _ = cat_month_map.update({agg_row.category: {}}) %}
                                    {% endif %}
                                    {% set _month_field = agg_row.date if agg_row.date is not none else agg_row.month %}
                                    {% set _month_key = _month_field.timestamp %}
                                    {% set _ = cat_month_map[agg_row.category].update({_month_key: agg_row}) %}
                                {% endfor %}

                                {% for category in cat_month_map.keys() | sort %}
                                <tr>
                                    <td><a href="/details/{{ result_id }}/{{ account.id }}/{{ category }}" class="clickable">{{ category }}</a></td>
                                    {% for month_display, month_ts in months | sort(attribute='1', reverse=True) %}
                                        {% set agg_row_data = cat_month_map[category].get(month_ts) %}
                                        {% if agg_row_data %}
                                            {% set details_list = [] %}
                                                {% for detail in agg_row_data.details %}
                                                {% set _ = details_list.append(detail.date.display ~ ': ' ~ detail.amount.display ~ ' - ' ~ detail.merchant) %}
                                            {% endfor %}
                                            {% set details_str = details_list | join('<br>') %}
                                            {% set highlight_key = month_display ~ '_' ~ category %}
                                            {% set highlight_type = account.highlights.get(highlight_key, '') %}
                                            {% set highlight_class = 'highlight-' ~ highlight_type if highlight_type else '' %}
                                            <td data-order="{{ agg_row_data.total.raw }}" class="{{ highlight_class }}"
                                                {% if agg_row_data.details %}
                                                    tabindex="0"
                                                    data-bs-toggle="popover"
                                                    data-bs-trigger="hover focus"
                                                    data-bs-html="true"
                                                    data-bs-content="{{ details_str }}"
                                                    data-bs-placement="top"
                                                    data-bs-custom-class="popover-wide"
                                                {% endif %}
                                            ><a href="/details/{{ result_id }}/{{ account.id }}/{{ category }}/{{ month_ts }}" class="clickable">{{ agg_row_data.total.display }}</a></td>
                                        {% else %}
                                            <td data-order="0"></td>
                                        {% endif %}
                                    {% endfor %}
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
        
        <div class="row">
            <div class="col-md-6">
                <a href="/" class="btn btn-secondary mt-3 mb-3">{{ _('Back') }}</a>
            </div>
        </div>
    </main>
    <footer class="bg-success text-white text-center py-3 mt-3">
        {% include 'footer.html' %}
    </footer>

    <script>
    document.addEventListener('DOMContentLoaded', function() {
        var tables = document.querySelectorAll('table[data-datatable="true"]');
        tables.forEach(function(table) {
            $(table).DataTable({
                responsive: false,
                fixedHeader: true,
                order: [],
                pageLength: 25,
                scrollX: true,
                autoWidth: false,
                dom: 'Bfrtip',
                buttons: [
                    {
                        extend: 'csv',
                        text: '{{ _("Export CSV") }}',
                        title: 'whatsthedamage_export'
                    },
                    {
                        extend: 'excel',
                        text: '{{ _("Export Excel") }}',
                        title: 'whatsthedamage_export'
                    }
                ]
            });
        });

        var popoverTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="popover"]'));
        var popoverList = popoverTriggerList.map(function (popoverTriggerEl) {
            return new bootstrap.Popover(popoverTriggerEl, {
                html: true,
                sanitize: false
            });
        });

        // Statistical Analysis Controls functionality
        var recalculateBtn = document.getElementById('recalculate-btn');
        var resetBtn = document.getElementById('reset-btn');
        var spinner = recalculateBtn.querySelector('.spinner-border');

        if (recalculateBtn && resetBtn) {
            // Recalculate button click handler
            recalculateBtn.addEventListener('click', function() {
                var algorithms = Array.prototype.slice.call(document.querySelectorAll('input[type="checkbox"][value]:checked'))
                    .map(function(el) { return el.value; });
                var direction = document.querySelector('input[name="direction"]:checked').value;

                // Show loading spinner
                spinner.classList.remove('d-none');
                recalculateBtn.querySelector('span:last-child').textContent = 'Processing...';
                recalculateBtn.disabled = true;
                resetBtn.disabled = true;

                fetch('/recalculate-statistics', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        result_id: '{{ result_id }}',
                        algorithms: algorithms,
                        direction: direction
                    })
                })
                .then(function(response) {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.json();
                })
                .then(function(data) {
                    if (data.status === 'success') {
                        // Update all cell highlights
                        updateCellHighlights(data.highlights);
                        showNotification('Statistics recalculated successfully!', 'success');
                    } else {
                        throw new Error(data.error || 'Unknown error');
                    }
                })
                .catch(function(error) {
                    console.error('Error:', error);
                    showNotification('Error recalculating statistics: ' + error.message, 'danger');
                })
                .finally(function() {
                    // Hide loading spinner
                    spinner.classList.add('d-none');
                    recalculateBtn.querySelector('span:last-child').textContent = 'Recalculate';
                    recalculateBtn.disabled = false;
                    resetBtn.disabled = false;
                });
            });

            // Reset button click handler
            resetBtn.addEventListener('click', function() {
                // Reset checkboxes to default (both checked)
                document.getElementById('algorithm-iqr').checked = true;
                document.getElementById('algorithm-pareto').checked = true;

                // Reset radio buttons to default (columns checked)
                document.getElementById('direction-columns').checked = true;

                // Trigger recalculation with default settings
                recalculateBtn.click();
            });
        }

        function updateCellHighlights(highlights) {
            // Remove all current highlights from all tables
            var highlightElements = document.querySelectorAll('[class*="highlight-"]');
            for (var i = 0; i < highlightElements.length; i++) {
                var el = highlightElements[i];
                el.classList.remove('highlight-outlier', 'highlight-pareto', 'highlight-excluded');
            }

            // Apply new highlights - process each table separately
            var tables = document.querySelectorAll('table[data-datatable="true"]');
            for (var t = 0; t < tables.length; t++) {
                var table = tables[t];
                var thead = table.querySelector('thead');
                var tbody = table.querySelector('tbody');

                if (thead && tbody) {
                    var headers = thead.querySelectorAll('th');
                    var rows = tbody.querySelectorAll('tr');

                    // Apply highlights for this specific table
                    for (var key in highlights) {
                        if (highlights.hasOwnProperty(key)) {
                            var highlightType = highlights[key];
                            var parts = key.split('_');
                            var column = parts[0];
                            var row = parts[1];

                            // Find the row by category in this table
                            for (var r = 0; r < rows.length; r++) {
                                var tr = rows[r];
                                var categoryCell = tr.querySelector('td:first-child');
                                if (categoryCell && categoryCell.textContent.trim() === row) {
                                    // Find the column by month in this table
                                    for (var c = 1; c < headers.length; c++) { // Skip first column (categories)
                                        if (headers[c].textContent.trim() === column) {
                                            var cell = tr.querySelector('td:nth-child(' + (c + 1) + ')');
                                            if (cell) {
                                                cell.classList.add('highlight-' + highlightType);
                                            }
                                            break;
                                        }
                                    }
                                    break;
                                }
                            }
                        }
                    }
                }
            }
        }

        function showNotification(message, type) {
            // Create notification element
            var notification = document.createElement('div');
            notification.className = 'alert alert-' + type + ' alert-dismissible fade show';
            notification.role = 'alert';
            notification.innerHTML = message + '<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>';

            // Add to page
            var main = document.querySelector('main');
            if (main) {
                main.insertBefore(notification, main.firstChild);

                // Auto-dismiss after 5 seconds
                setTimeout(function() {
                    notification.classList.remove('show');
                    setTimeout(function() { notification.remove(); }, 150);
                }, 5000);
            }
        }
    });
    </script>
</body>
</html>
